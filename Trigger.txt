CREATE TRIGGER trg_AfterUpdateGiaoDich
ON GIAODICH
AFTER UPDATE 
AS 
BEGIN
	UPDATE NGUOIDUNG 
	SET TONGTIEN  = TONGTIEN + (
		SELECT 
		CASE 
			WHEN LOAIGIAODICH.TRANGTHAI = 'IN' THEN INSERTED.TIEN
			WHEN LOAIGIAODICH.TRANGTHAI = 'OUT' THEN -INSERTED.TIEN
			ELSE 0
		END
		FROM INSERTED 
		INNER JOIN LOAIGIAODICH ON INSERTED.MALOAIGD = LOAIGIAODICH.MALOAIGD
		)
	FROM NGUOIDUNG 
	INNER JOIN INSERTED ON NGUOIDUNG.ID = INSERTED.ID;

	UPDATE NGUOIDUNG 
	SET TONGTIEN  = TONGTIEN - (
		SELECT 
		CASE 
			WHEN LOAIGIAODICH.TRANGTHAI = 'IN' THEN DELETED.TIEN
			WHEN LOAIGIAODICH.TRANGTHAI = 'OUT' THEN -DELETED.TIEN
			ELSE 0
		END
		FROM DELETED
		INNER JOIN LOAIGIAODICH ON DELETED.MALOAIGD = LOAIGIAODICH.MALOAIGD
		)
	FROM NGUOIDUNG 
	INNER JOIN DELETED ON NGUOIDUNG.ID = DELETED.ID;
	
	UPDATE NGANSACH 
	SET TIENNS = TIENNS + (
		SELECT 
		CASE 
			WHEN LOAIGIAODICH.TRANGTHAI = 'IN' THEN INSERTED.TIEN
			WHEN LOAIGIAODICH.TRANGTHAI = 'OUT' THEN -INSERTED.TIEN
			ELSE 0
		END
		FROM INSERTED 
		INNER JOIN LOAIGIAODICH ON INSERTED.MALOAIGD = LOAIGIAODICH.MALOAIGD
		)
	FROM NGANSACH 
	INNER JOIN INSERTED ON NGANSACH.ID = INSERTED.ID
	WHERE MONTH(HSD) = MONTH(NGAYTAO) AND YEAR(HSD) = YEAR(NGAYTAO);

	UPDATE NGANSACH 
	SET TIENNS = TIENNS - (
		SELECT 
		CASE 
			WHEN LOAIGIAODICH.TRANGTHAI = 'IN' THEN DELETED.TIEN
			WHEN LOAIGIAODICH.TRANGTHAI = 'OUT' THEN -DELETED.TIEN
			ELSE 0
		END
		FROM DELETED 
		INNER JOIN LOAIGIAODICH ON DELETED.MALOAIGD = LOAIGIAODICH.MALOAIGD
		)
	FROM NGANSACH 
	INNER JOIN DELETED ON NGANSACH.ID = DELETED.ID
	WHERE MONTH(HSD) = MONTH(NGAYTAO) AND YEAR(HSD) = YEAR(NGAYTAO);
END;

CREATE TRIGGER trg_AfterInsertGiaoDich
ON GIAODICH
AFTER INSERT 
AS 
BEGIN
	UPDATE NGUOIDUNG 
	SET TONGTIEN  = TONGTIEN + (
		SELECT 
		CASE 
			WHEN LOAIGIAODICH.TRANGTHAI = 'IN' THEN INSERTED.TIEN
			WHEN LOAIGIAODICH.TRANGTHAI = 'OUT' THEN -INSERTED.TIEN
			ELSE 0
		END
		FROM INSERTED 
		INNER JOIN LOAIGIAODICH ON INSERTED.MALOAIGD = LOAIGIAODICH.MALOAIGD
		)
	FROM NGUOIDUNG 
	INNER JOIN INSERTED ON NGUOIDUNG.ID = INSERTED.ID;
	
	UPDATE NGANSACH 
	SET TIENNS = TIENNS + (
		SELECT 
		CASE 
			WHEN LOAIGIAODICH.TRANGTHAI = 'IN' THEN INSERTED.TIEN
			WHEN LOAIGIAODICH.TRANGTHAI = 'OUT' THEN -INSERTED.TIEN
			ELSE 0
		END
		FROM INSERTED 
		INNER JOIN LOAIGIAODICH ON INSERTED.MALOAIGD = LOAIGIAODICH.MALOAIGD
		)
	FROM NGANSACH 
	INNER JOIN INSERTED ON NGANSACH.ID = INSERTED.ID
	WHERE MONTH(HSD) = MONTH(NGAYTAO) AND YEAR(HSD) = YEAR(NGAYTAO);
END;

CREATE TRIGGER trg_AfterDeleteGiaoDich
ON GIAODICH
AFTER DELETE
AS 
BEGIN
	UPDATE NGUOIDUNG 
	SET TONGTIEN  = TONGTIEN - (
		SELECT 
		CASE 
			WHEN LOAIGIAODICH.TRANGTHAI = 'IN' THEN DELETED.TIEN
			WHEN LOAIGIAODICH.TRANGTHAI = 'OUT' THEN -DELETED.TIEN
			ELSE 0
		END
		FROM DELETED
		INNER JOIN LOAIGIAODICH ON DELETED.MALOAIGD = LOAIGIAODICH.MALOAIGD
		)
	FROM NGUOIDUNG 
	INNER JOIN DELETED ON NGUOIDUNG.ID = DELETED.ID;
	
	UPDATE NGANSACH 
	SET TIENNS = TIENNS - (
		SELECT 
		CASE 
			WHEN LOAIGIAODICH.TRANGTHAI = 'IN' THEN DELETED.TIEN
			WHEN LOAIGIAODICH.TRANGTHAI = 'OUT' THEN -DELETED.TIEN
			ELSE 0
		END
		FROM DELETED 
		INNER JOIN LOAIGIAODICH ON DELETED.MALOAIGD = LOAIGIAODICH.MALOAIGD
		)
	FROM NGANSACH 
	INNER JOIN DELETED ON NGANSACH.ID = DELETED.ID
	WHERE MONTH(HSD) = MONTH(NGAYTAO) AND YEAR(HSD) = YEAR(NGAYTAO);
END;
